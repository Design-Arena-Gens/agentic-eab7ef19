"use client";

import { useCallback, useEffect, useMemo, useRef, useState } from "react";

type Slide = {
  title: string;
  bullets?: string[];
  subtitle?: string;
  center?: boolean;
};

const slidesData: Slide[] = [
  {
    title: "AI?????????",
    subtitle: "??????????",
    center: true,
  },
  {
    title: "????",
    bullets: [
      "???AI???????????",
      "?AI???????????",
    ],
  },
  {
    title: "?????????",
    bullets: [
      "AI?????",
      "AI???????",
      "??????",
    ],
  },
  {
    title: "Google ?????",
    bullets: [
      "Vertex AI / Gemini for Workspace / AI Studio",
      "Colab / Kaggle?????????",
      "AppSheet / Looker Studio???????????",
      "Cloud Run / BigQuery?????????",
    ],
  },
  {
    title: "?????????",
    bullets: [
      "??????????????????????",
      "?AI??????????????????",
    ],
  },
  {
    title: "?????????",
    bullets: [
      "?????????????X???",
      "?????????????PoC???",
      "????????????????",
    ],
  },
  {
    title: "???????",
    bullets: [
      "????????????????",
      "????????????",
      "??????????????",
    ],
  },
  {
    title: "????",
    bullets: [
      "??2????Kickoff?",
      "???????????QBR?",
    ],
  },
  {
    title: "????",
    bullets: [
      "Y26 Q3~Q4??????",
      "??AI???????????",
    ],
  },
  {
    title: "?????",
    bullets: [
      "?????????",
      "??????????",
      "????????????",
    ],
  },
  {
    title: "KPI ???",
    bullets: [
      "AI????????????",
      "PoC???????????ROI",
      "???????????????",
    ],
  },
  {
    title: "Q&A",
    subtitle: "????",
    center: true,
  },
];

export default function SlidesPage() {
  const [index, setIndex] = useState(0);
  const total = slidesData.length;
  const go = useCallback((delta: number) => {
    setIndex((i) => Math.max(0, Math.min(total - 1, i + delta)));
  }, [total]);

  useEffect(() => {
    const onKey = (e: KeyboardEvent) => {
      if (e.key === "ArrowRight" || e.key.toLowerCase() === "d") go(1);
      if (e.key === "ArrowLeft" || e.key.toLowerCase() === "a") go(-1);
    };
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
  }, [go]);

  const current = slidesData[index];

  const downloadPptx = useCallback(async () => {
    try {
      const PptxGenJS = (await import("pptxgenjs")).default;
      const pptx = new PptxGenJS();
      pptx.title = "AI ?????????";

      slidesData.forEach((s) => {
        const slide = pptx.addSlide();
        slide.addText(s.title, { x: 0.5, y: 0.5, fontSize: 28, bold: true });
        if (s.subtitle) {
          slide.addText(s.subtitle, { x: 0.5, y: 1.2, fontSize: 20, color: "666666" });
        }
        if (s.bullets && s.bullets.length > 0) {
          slide.addText(s.bullets.map((b) => `? ${b}`).join("\n"), {
            x: 0.7,
            y: s.subtitle ? 2 : 1.5,
            fontSize: 18,
            color: "333333",
            bullet: true,
          });
        }
      });

      await pptx.writeFile({ fileName: "AI_???????_??.pptx" });
    } catch (err) {
      console.error(err);
      alert("????????????");
    }
  }, []);

  const progress = useMemo(() => ((index + 1) / total) * 100, [index, total]);

  return (
    <div className="slides-root">
      <div className="slides-toolbar">
        <button className="ghost" onClick={() => go(-1)} disabled={index === 0}>? ???</button>
        <div className="spacer" />
        <div className="idx">{index + 1} / {total}</div>
        <div className="spacer" />
        <button onClick={downloadPptx}>?? PPTX</button>
        <a className="ghost" href="/">??</a>
      </div>

      <div className={`slide ${current.center ? "center" : ""}`}>
        <h2>{current.title}</h2>
        {current.subtitle && <p className="subtitle">{current.subtitle}</p>}
        {current.bullets && (
          <ul>
            {current.bullets.map((b, i) => (
              <li key={i}>{b}</li>
            ))}
          </ul>
        )}
      </div>

      <div className="progress"><div style={{ width: `${progress}%` }} /></div>

      <div className="nav-hint">???? ? ? ????</div>
    </div>
  );
}
